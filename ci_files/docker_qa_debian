FROM debian:sid
MAINTAINER Jiff <Jeff@bynd.com>
LABEL version="1.0"
LABEL description="A machine with all the \
qa dependencies installed."



RUN apt-get update && apt-get install -y \
	curl \
	python3.6 \
	python3-pip \
	python3-setuptools \
	python3-dev \
	ca-certificates \
	apt-transport-https \
	--no-install-recommends \
	build-essential \
	gcc \
	libev-dev \
	gnupg \
	unzip \
	firefox \
	&& curl -sSL https://deb.nodesource.com/setup_8.x | bash - \
	&& curl -sSL https://dl.google.com/linux/linux_signing_key.pub | apt-key add - \
	&& echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
	&& apt-get update && apt-get install -y \
		google-chrome-stable \
		nodejs \
		--no-install-recommends \
	&& npm --global install yarn \
  && rm -rf /var/lib/apt/lists/*

# until pip 9.0.2 fixes https://github.com/pypa/pip/issues/4216#issuecomment-310287598
RUN pip3 install -I https://github.com/pypa/pip/archive/master.zip#egg=pip

# Install Google Chrome
RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
# RUN dpkg -i google-chrome*.deb
RUN npm install -g chrome
RUN export CHROME_PATH=/usr/local/bin:$PATH

RUN mkdir qa
RUN pip3 install virtualenv
RUN virtualenv qa/env -p python3.6

# Lighthouse
ARG CACHEBUST=1
RUN yarn global add lighthouse

# Maybe works second time due to cache
RUN ls
RUN . qa/env/bin/activate
# Functional Testing + other main installs
RUN pip3 install requests==2.18.1
RUN pip3 install selenium==3.6.0
RUN pip3 install behave==1.2.5

# Donload Compressed Chromedriver and geckodriver (Firefox)
RUN wget https://chromedriver.storage.googleapis.com/2.30/chromedriver_linux64.zip -O temp.zip
RUN wget https://github.com/mozilla/geckodriver/releases/download/v0.19.0/geckodriver-v0.19.0-linux64.tar.gz -O temp.tar.gz
# Decompress files downloaded in previous step
RUN unzip temp.zip
RUN tar -xvzf temp.tar.gz
# Move drivers to the path and delete compressed versions
RUN mv chromedriver qa/env/bin && rm temp.zip
RUN mv geckodriver qa/env/bin && rm temp.tar.gz
RUN ls

# Locust Installs
RUN pip3 install -I https://github.com/pypa/pip/archive/master.zip#egg=pip
RUN pip3 install wheel
RUN pip3 install locustio==0.7.5
RUN pip3 install pyzmq==16.0.2

# Zap Install
RUN pip3 install python-owasp-zap-v2.4==0.0.11
RUN pip3 install zapcli==0.8.0

# Google Auth Installs
RUN pip3 install google-auth==1.0.2
RUN pip3 install google-api-python-client==1.6.2
RUN pip3 install requests-toolbelt==0.8.0
RUN pip3 install eyes-selenium==3.10.4


ENV LIGHTHOUSE_PORT '--port 8080'
ENV PAGE_NAME 'index'
ENV LIGHTHOUSE_OUTPUT_FOLDER '--output-path=qa/accessibility/output/'
ENV LIGHTHOUSE_FILE_FORMAT '--output json --output html'
ENV LIGHTHOUSE_MISC_OPTIONS '--disable-storage-reset --max-wait-for-load=20 --chrome-flags=" --no-sandbox --disable-gpu --headless"'
ENV LIGHTHOUSE_SCAN_ADDRESS = 'http://172.19.0.1:3000'
ENV LIGHTHOUSE_OUTPUT_PATH = $LIGHTHOUSE_OUTPUT_FOLDER$PAGE_NAME

# PORT for Lighthouse
EXPOSE 8080

# Debug
RUN echo ${LIGHTHOUSE_OUTPUT_PATH}

# Command for Lighthouse
CMD [ "lighthouse", "--verbose", "CHROME_PATH=/usr/local/bin", "${LIGHTHOUSE_PORT}", "${LIGHTHOUSE_FILE_FORMAT}", "${LIGHTHOUSE_OUTPUT_PATH}", "${LIGHTHOUSE_MISC_OPTIONS}" ,"${LIGHTHOUSE_SCAN_ADDRESS}"]
